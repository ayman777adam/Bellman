<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashBox Secure - Final System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> 
    
    <style>
        /* --- 1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª --- */
        :root {
            --bg-dark: #1A2C46; --bg-panel: #2C4A73; --primary: #F7C934; 
            --secondary: #3498DB; --text-main: #ECF0F1; --text-muted: #BDC3C7;
            --border-glass: rgba(255, 255, 255, 0.15); 
            --success: #2ecc71; --danger: #e74c3c; --warning: #f39c12; --gold: #FFD700;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; overflow-x: hidden; }
        .dashboard-container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 240px; background: rgba(26, 44, 70, 0.98); border-left: 1px solid var(--border-glass); display: flex; flex-direction: column; padding: 20px; }
        .logo { color: var(--primary); font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 40px; }
        .nav-item { display: block; padding: 12px 15px; color: var(--text-muted); text-decoration: none; border-radius: 8px; font-weight: 600; margin-bottom: 8px; background: rgba(255,255,255,0.03); transition: 0.3s; }
        .nav-item.active { background: var(--secondary); color: white; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; background: linear-gradient(135deg, var(--bg-dark), #243b55); overflow-y: auto; }
        
        /* Topbar */
        .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-glass); }
        .user-area { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); padding: 8px 20px; border-radius: 50px; border: 1px solid var(--border-glass); }
        .online-dot { width: 10px; height: 10px; background-color: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); animation: pulse 2s infinite; }
        .username-text { font-weight: 800; color: var(--primary); margin-right: 5px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .btn-big { padding: 8px 20px; font-size: 0.9rem; border-radius: 6px; font-weight: bold; border: 1px solid var(--border-glass); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); color: white; }
        .btn-big:hover { background: rgba(255,255,255,0.1); }
        .btn-logout { border-color: rgba(231, 76, 60, 0.5); color: #ff6b6b; }

        /* Metrics (UPDATED to support charts) */
        .dashboard-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .metric-card { 
            background: rgba(255,255,255,0.04); padding: 15px; border-radius: 12px; 
            border: 1px solid var(--border-glass); text-align: center;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .metric-card h4 { color: var(--text-muted); margin: 0 0 5px; font-size: 0.85rem; }
        .metric-card p { color: white; font-size: 1.4rem; font-weight: 700; margin: 0; direction: ltr; font-family: 'Inter'; }

        /* Chart Container for Sparklines (NEW) */
        .chart-container { 
            height: 50px; /* Ø§Ø±ØªÙØ§Ø¹ ØµØºÙŠØ± Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ù…ØµØºØ± */
            width: 100%; 
            margin-top: 10px;
        }

        /* Table */
        .table-wrapper { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--border-glass); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        thead th { background: rgba(0,0,0,0.4); color: var(--primary); padding: 10px; text-align: center; font-size: 0.85rem; white-space: nowrap; border-bottom: 2px solid var(--border-glass); }
        tbody td { padding: 8px; border-bottom: 1px solid var(--border-glass); text-align: center; font-size: 0.9rem; color: var(--text-main); vertical-align: middle; }
        
        /* Active Row Glow */
        .active-row { 
            background: rgba(52, 152, 219, 0.05); 
            border-left: 4px solid var(--success);
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.5); 
        }
        .closed-row { background: rgba(0,0,0,0.25); color: #999; border-left: 4px solid var(--danger); }
        
        td[contenteditable="true"] { background: rgba(255,255,255,0.05); border-radius: 4px; color: white; min-width: 50px; font-family: 'Inter'; transition: 0.2s; }
        td[contenteditable="true"]:focus { background: var(--bg-panel); outline: 1px solid var(--primary); color: var(--primary); font-weight: bold; }
        
        /* Notes Logic */
        .notes-cell-readonly { cursor: pointer; font-size: 1.3rem; position: relative; }
        .note-has-text { color: var(--danger); } 
        .note-empty { color: var(--success); }
        .notes-tooltip { display:none; position:absolute; bottom:100%; left:50%; transform:translateX(-50%); width:200px; background:#000; color:#fff; padding:8px; border-radius:8px; font-size:0.8rem; z-index:100; box-shadow:0 5px 15px rgba(0,0,0,0.5); text-align:right; pointer-events:none; white-space: normal; }
        .notes-cell-readonly:hover .notes-tooltip { display:block; }

        /* Pagination */
        .pagination-container { display: flex; justify-content: center; gap: 10px; margin-top: 15px; direction: ltr; }
        .page-btn { padding: 5px 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-glass); color: var(--text-muted); border-radius: 6px; cursor: pointer; font-family: 'Inter'; font-weight: bold; }
        .page-btn.active { background: var(--primary); color: var(--bg-dark); border-color: var(--primary); }

        /* --- Tools Layout (FIXED EQUAL WIDTHS) --- */
        .tools-container { width: 100%; max-width: 1200px; margin: 0 auto; }
        .tools-wrapper { 
            display: flex; 
            justify-content: space-between; 
            gap: 20px; 
            align-items: stretch; 
        }
        .tool-card { 
            flex: 1; 
            width: 33.33%;
            background: rgba(255,255,255,0.03); 
            border-radius: 12px; 
            padding: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´ÙˆØ© */
            border: 1px solid var(--border-glass); 
            display: flex; 
            flex-direction: column; 
            height: 500px; 
        }
        .tool-card h3 { color: var(--secondary); margin: 0 0 10px 0; font-size: 1rem; text-align: center; border-bottom: 1px solid var(--border-glass); padding-bottom: 8px; }

        /* Notes Box */
        #notesBox { width: 100%; flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--border-glass); color: white; padding: 12px; border-radius: 8px; resize: none; font-size: 1.2rem; max-height: 100%; }

        /* Calculator */
        .calc-display { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--border-glass); color: var(--primary); font-size: 1.6rem; text-align: right; padding: 10px; margin-bottom: 10px; border-radius: 8px; font-family: 'Inter'; font-weight: bold; height: 50px; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
        .calc-grid button { padding: 12px 0; font-size: 1.2rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border-glass); color: white; border-radius: 6px; cursor: pointer; transition: 0.2s; font-family: 'Inter'; }
        .calc-grid button:hover { background: rgba(255,255,255,0.15); }
        .calc-grid button.eq-btn { background: var(--primary); color: var(--bg-dark); grid-row: span 2; }
        .calc-history { flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--border-glass); border-radius: 8px; padding: 8px; overflow-y: auto; color: #888; font-size: 0.9rem; text-align: right; direction: ltr; }

        /* Cash Calculator (No Scroll Fix + Tight Padding) */
        .cash-table-container { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        #cashCalcTable { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #cashCalcTable th { padding: 4px; /* Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ */ font-size: 0.85rem; color: var(--text-muted); position: sticky; top: 0; background: var(--bg-dark); z-index: 1; width: 33.33%; }
        #cashCalcTable td { padding: 3px; /* Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ */ border-bottom: 1px solid rgba(255,255,255,0.05); font-family: 'Inter'; font-size: 0.9rem; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */ text-align: center; }
        .cash-input { background: transparent !important; border: 1px solid var(--border-glass) !important; color: white !important; text-align: center; border-radius: 4px; padding: 2px; /* Ø¶ØºØ· Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ */ width: 100%; }
        .cash-input:focus { border-color: var(--primary) !important; background: rgba(255,255,255,0.05) !important; }
        
        .cash-btn { width: 100%; padding: 8px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; margin-top: 5px; font-size: 1rem; }
        .btn-apply { background: var(--primary); color: var(--bg-dark); }
        .btn-clear { background: rgba(255,255,255,0.1); color: white; }

        /* Action Buttons */
        .close-wrapper { margin: 20px 0; text-align: center; display: flex; justify-content: center; gap: 20px; height: 55px; }
        .btn-close, .btn-cancel { 
            width: 100%; max-width: 300px; height: 100%; 
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; font-weight: bold; border-radius: 10px; cursor: pointer; transition: 0.3s; 
        }
        .btn-close { background: var(--bg-panel); border: 2px solid var(--primary); color: var(--primary); }
        .btn-close:hover { background: var(--primary); color: var(--bg-dark); box-shadow: 0 0 20px rgba(247, 201, 52, 0.4); }
        .btn-cancel { background: rgba(231, 76, 60, 0.15); border: 2px solid var(--danger); color: #ff6b6b; display: none; animation: urgentPulse 1s infinite; box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }
        @keyframes urgentPulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Toast */
        .toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; text-align: center; width: auto; }
        .toast { background: rgba(26, 44, 70, 0.95); color: white; padding: 20px 40px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 40px rgba(0,0,0,0.6); font-size: 1.3rem; font-weight: bold; backdrop-filter: blur(10px); animation: popIn 0.3s ease; }
        .toast-success { color: var(--success); border-color: var(--success); }
        .toast-error { color: var(--danger); border-color: var(--danger); }
        .toast-warning { color: var(--warning); border-color: var(--warning); }
        .toast-gold { color: var(--gold); border-color: var(--gold); box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .security-modal { background: var(--bg-panel); border: 1px solid var(--primary); padding: 30px; border-radius: 15px; width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .security-modal h3 { color: var(--primary); margin-top: 0; }
        .security-modal p { color: #ddd; font-size: 1.1rem; margin-bottom: 25px; }
        .modal-btns { display: flex; gap: 15px; justify-content: center; }
        .btn-modal { padding: 10px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-confirm { background: var(--danger); color: white; }
        .btn-cancel-modal { background: rgba(255,255,255,0.1); color: white; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: var(--bg-panel); border-radius: 3px; }

        /* Print Specific Styles */
        @media print {
            body { background: #fff !important; color: #000 !important; font-size: 12pt !important; }
            .dashboard-container, .sidebar, .topbar, .dashboard-metrics, .close-wrapper, .tools-container, .pagination-container { display: none !important; }
            .table-wrapper { box-shadow: none !important; border: none !important; padding: 0 !important; }
            
            /* For Single Receipt Print */
            .print-receipt-section { display: block !important; padding: 30px; }
            .header-print h2 { font-size: 20pt; margin-bottom: 10px; }
            .details-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
            .details-table th, .details-table td { padding: 15px !important; border: 1px solid #000 !important; font-size: 14pt !important; }
            .details-table th { background: #f0f0f0 !important; text-align: right; width: 50%; }
            .details-table td { text-align: left; font-weight: bold; }
            .final-total { font-size: 16pt !important; background: #ddd !important; }
            .signature-area { margin-top: 50px !important; display: flex !important; justify-content: flex-end !important; width: 100%; }
            .signature-box { border-top: 2px solid #000 !important; width: 35% !important; text-align: center; padding-top: 10px; font-size: 14pt !important; }
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <aside class="sidebar">
        <div class="logo">CashBox Secure</div>
        <nav>
            <a href="#" class="nav-item active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <div class="user-area">
                <div class="online-dot"></div>
                <div>
                    <span class="greeting-text" id="greetingMsg">Ø£Ù‡Ù„Ø§Ù‹ØŒ</span>
                    <span class="username-text" id="username">User</span>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-big" onclick="printLast()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±</button>
                <button class="btn-big" onclick="printAll()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
                <button class="btn-big btn-logout" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <section class="dashboard-metrics">
            <div class="metric-card">
                <h4>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</h4><p id="mRevenue">0.00</p>
                <div class="chart-container"><canvas id="chartRevenue"></canvas></div>
            </div>
            <div class="metric-card">
                <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´</h4><p id="mCash">0.00</p>
                <div class="chart-container"><canvas id="chartCash"></canvas></div>
            </div>
            <div class="metric-card">
                <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©</h4><p id="mNet">0.00</p>
                <div class="chart-container"><canvas id="chartNet"></canvas></div>
            </div>
            <div class="metric-card">
                <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</h4><p id="mVariance" style="color: #aaa;">0.00</p>
                <div class="chart-container"><canvas id="chartVariance"></canvas></div>
            </div>
        </section>

        <section class="table-wrapper">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                <h3 style="margin:0; color:var(--text-main); font-size:1.1rem;">Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ÙŠÙˆÙ…</th>
                        <th>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th>
                        <th>ÙÙˆØ§ØªÙŠØ±</th>
                        <th>Ù…Ø¹Ù„Ù‚Ø§Øª</th>
                        <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                        <th>Ø§Ù„ÙƒØ§Ø´</th>
                        <th>Ø§Ù„Ø´Ø¨ÙƒØ©</th>
                        <th>ØªØ­ÙˆÙŠÙ„</th>
                        <th>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
                        <th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th>
                        <th style="width:60px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div class="pagination-container" id="paginationControls"></div>
        </section>

        <section class="close-wrapper">
            <button id="cancelBtn" class="btn-cancel" onclick="cancelClosure()">âŒ ØªØ±Ø§Ø¬Ø¹ ÙˆØªØ¹Ø¯ÙŠÙ„</button>
            <button id="closeBtn" class="btn-close" onclick="startClosure()">ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</button>
        </section>

        <div class="tools-container">
            <section class="tools-wrapper">
                <div class="tool-card">
                    <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
                    <textarea id="notesBox" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø© Ù‡Ù†Ø§..."></textarea>
                </div>

                <div class="tool-card">
                    <h3>ğŸ§® Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</h3>
                    <input type="text" id="calcDisplay" class="calc-display" value="0" readonly>
                    <div class="calc-grid">
                        <button onclick="calcClear(true)" style="color: #e74c3c;">C</button>
                        <button onclick="calcOp('/')" class="op-btn">Ã·</button>
                        <button onclick="calcOp('*')" class="op-btn">Ã—</button>
                        <button onclick="calcDel()" class="op-btn">âŒ«</button>
                        <button onclick="calcNum(7)">7</button><button onclick="calcNum(8)">8</button><button onclick="calcNum(9)">9</button><button onclick="calcOp('-')" class="op-btn">-</button>
                        <button onclick="calcNum(4)">4</button><button onclick="calcNum(5)">5</button><button onclick="calcNum(6)">6</button><button onclick="calcOp('+')" class="op-btn">+</button>
                        <button onclick="calcNum(1)">1</button><button onclick="calcNum(2)">2</button><button onclick="calcNum(3)">3</button><button onclick="calcEq()" class="eq-btn">=</button>
                        <button onclick="calcNum(0)" style="grid-column: span 2;">0</button><button onclick="calcNum('.')">.</button>
                    </div>
                    <div class="calc-history" id="calcHistory"><div>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</div></div>
                </div>

                <div class="tool-card">
                    <h3>ğŸ’µ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´</h3>
                    <div class="cash-table-container">
                        <table id="cashCalcTable">
                            <thead><tr><th>ÙØ¦Ø©</th><th>Ø¹Ø¯Ø¯</th><th>Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div style="text-align:center; margin-bottom:10px; color:var(--primary); font-weight:bold;">
                        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="cashTotalDisplay" style="font-family:'Inter';">0</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="cash-btn btn-apply" onclick="applyCash()">Ù†Ù‚Ù„ Ù„Ù„ÙƒØ§Ø´</button>
                        <button class="cash-btn btn-clear" onclick="clearCashTable()">ØªØµÙÙŠØ±</button>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<div id="securityModal" class="modal-overlay">
    <div class="security-modal">
        <h3>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ</h3>
        <p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº ØªÙ… Ù†Ù‚Ù„Ù‡ Ø¢Ù„ÙŠØ§Ù‹ Ù…Ù† Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´.<br>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŸ</p>
        <div class="modal-btns">
            <button class="btn-modal btn-confirm" id="confirmUnlockBtn">Ù†Ø¹Ù…ØŒ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn-modal btn-cancel-modal" id="cancelUnlockBtn">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<script>
    // --- API Configuration ---
    const API_BASE_URL = "https://cashbox-backend.onrender.com/api"; // **Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø¹Ù†ÙˆØ§Ù† API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¹Ù„Ù‰ Render**
    
    // --- Global State ---
    let timerInterval;
    let isClosing = false;
    let currentNum = "0", prevNum = null, operator = null;
    const denoms = [500, 200, 100, 50, 20, 10, 5, 1];
    const ROWS_PER_PAGE = 10; 
    let currentPage = 1;
    let pendingUnlockElement = null; 
    
    const quotes = ["ÙŠØ§ ÙÙ†Ø§Ù†!", "Ø§Ù„Ù„Ù‡ ÙŠÙ†ÙˆØ±!", "ØªØ³Ù„Ù… Ø§ÙŠØ¯Ùƒ!", "Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹!", "Ù…Ù…ØªØ§Ø²!", "Ø´ØºÙ„ Ø¹Ø§Ù„ÙŠ!"];
    const daysMap = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

    document.addEventListener("DOMContentLoaded", () => {
        const user = localStorage.getItem("username");
        if (!user) window.location.href = "index.html";
        document.getElementById("username").textContent = user;
        
        const h = new Date().getHours();
        document.getElementById("greetingMsg").textContent = h<12?"ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±ØŒ":"Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±ØŒ";

        // Initial Data Load (Now uses loadData logic)
        loadData();
        initCashTable();
        document.body.addEventListener('keydown', validateInput);
        
        document.getElementById("confirmUnlockBtn").addEventListener("click", confirmUnlock);
        document.getElementById("cancelUnlockBtn").addEventListener("click", closeSecurityModal);
    });

    // --- API Helper Function ---
    async function apiRequest(endpoint, method = "GET", data = null) {
        const token = localStorage.getItem("token"); // Assuming a token might be stored on login
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        };

        // Add Authorization header if token exists
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const config = {
            method: method,
            headers: headers,
        };

        if (data && method !== "GET") {
            config.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(API_BASE_URL + endpoint, config);
            const responseData = await response.json();

            if (!response.ok) {
                // Handle API error messages
                showToast(responseData.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ API", "error");
                console.error(`API Error on ${endpoint}:`, responseData);
                return null;
            }

            return responseData;
        } catch (error) {
            console.error('Fetch Error:', error);
            showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "error");
            return null;
        }
    }

    // --- Logic 2: Load and Display (Updated for API/Object structure) ---
    function loadData() {
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ LocalStorage Ù„Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ø³Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
        const allClosed = JSON.parse(localStorage.getItem("closedRowsV10") || "[]");
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        
        if(currentPage === 1) createNewRow(tbody);

        let start, end;
        // Page 1 shows the New Row + the last 3 closed reports
        if(currentPage === 1) { start = 0; end = 3; } 
        // Other pages show the rest of the reports (10 per page)
        else { start = 3 + (currentPage - 2) * 10; end = start + 10; }
        
        const totalPages = Math.ceil((allClosed.length - 3) / 10) + 1;
        const safeTotalPages = totalPages < 1 ? 1 : totalPages;
        if(currentPage > safeTotalPages) currentPage = safeTotalPages;

        const pageRows = allClosed.slice(start, end);

        pageRows.forEach(rowData => {
            const tr = document.createElement("tr");
            tr.className = "closed-row";
            
            // NOTE: rowData is now an object with keys matching the closure data structure
            const dataArray = [
                rowData.dayName, rowData.treasuryReserve, rowData.purchaseInvoices, rowData.temporarySuspensions, 
                rowData.employeeName, rowData.closeTime, rowData.actualCash, rowData.network, 
                rowData.bankTransfer, rowData.programRevenue, rowData.variance, rowData.notes
            ];

            dataArray.forEach((t, i) => {
                const td = document.createElement("td");
                // The indices below map to the table columns in the HTML
                if(i===0) td.textContent = t; // Day
                else if(i===5) td.textContent = t; // Date/Time
                else if(i===11) { // Notes (Index 11 in dataArray)
                    td.className = "notes-cell-readonly";
                    const hasNote = t && t.trim().length > 0;
                    const icon = hasNote ? "ğŸ”´" : "ğŸŸ¢";
                    td.innerHTML = `<span class="${hasNote?'note-has-text':'note-empty'}">${icon}</span><span class="notes-tooltip">${t||'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</span>`;
                } else if(i===10) { // Variance (Index 10 in dataArray)
                     const v = parseFloat(t)||0;
                     td.textContent = v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                     td.style.color = v===0?"#aaa":(v>0?"var(--success)":"var(--danger)");
                } else {
                    // All other numerical/text fields
                    td.textContent = (typeof t === 'number') ? t.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : t;
                }
                tr.appendChild(td);
            });
            
            // Status Cell (Last column)
            const statusTd = document.createElement("td");
            statusTd.innerHTML = '<span class="status-closed status-badge">ğŸ”’ Ù…ØºÙ„Ù‚</span>';
            tr.appendChild(statusTd);

            tbody.appendChild(tr);
        });
        
        renderPagination(safeTotalPages);
        updateMetrics(); // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ³ØªØ¯Ø¹ÙŠ renderCharts ÙÙŠ Ù†Ù‡Ø§ÙŠØªÙ‡Ø§
    }

    // --- Render & Pagination ---
    function renderTable() {
        // Renamed to loadData for better context
        loadData();
    }

    function renderPagination(total) {
        const c = document.getElementById("paginationControls"); 
        if(c) { 
            c.innerHTML = ""; 
            if(total<=1) return; 
            for(let i=1; i<=total; i++) {
                const b = document.createElement("button"); 
                // Naming fix: Page 1 is 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'
                b.textContent = (i === 1) ? 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : i;
                b.className = `page-btn ${i===currentPage?'active':''}`;
                b.onclick=()=>{currentPage=i;loadData();}; // Use loadData
                c.appendChild(b);
            }
        }
    }

    function createNewRow(tbody) {
        const row = document.createElement("tr");
        row.className = "active-row";
        const user = document.getElementById("username").textContent;
        const today = daysMap[new Date().getDay()];
        const cell = (cls="") => `<td contenteditable="true" oninput="calcRow(this)" onfocus="focusCell(this)" onblur="blurCell(this)" class="${cls}">0</td>`;
        row.innerHTML = `
            <td>${today}</td> ${cell()} ${cell()} ${cell()} 
            <td>${user}</td> <td class="time-cell">-</td>
            ${cell('cash-cell')} ${cell()} ${cell()} ${cell('rev-cell')}
            <td class="var-cell" style="color:#aaa;">0.00</td> <td class="notes-cell-readonly"></td>
            <td class="status-cell"><span class="status-active status-badge">Ù†Ø´Ø· ğŸŸ¢</span></td>
        `;
        tbody.appendChild(row);
    }

    function focusCell(el) {
        if(el.dataset.autoFilled === "true") {
            pendingUnlockElement = el;
            document.getElementById("securityModal").style.display = "flex";
            el.blur();
        } else {
            // Store the full formatted text, but input should show a clean number or empty.
            el.dataset.oldVal = convertArabic(el.textContent).replace(/,/g, ''); // Remove Arabic & commas for clean storage
            el.textContent = "";
        }
    }
    function blurCell(el) { 
        let val = parseFloat(convertArabic(el.textContent)) || 0;
        if(el.textContent === "" || isNaN(val)) {
             // If empty or non-numeric, restore old value or '0'
             val = parseFloat(el.dataset.oldVal) || 0;
        }
        el.textContent = val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); // Reformat for display
        calcRow(el); 
    }

    function confirmUnlock() {
        if(pendingUnlockElement) {
            pendingUnlockElement.dataset.autoFilled = "false";
            // Set the old value to the formatted text but clear the cell for new input
            pendingUnlockElement.dataset.oldVal = pendingUnlockElement.textContent; 
            pendingUnlockElement.textContent = "";
            pendingUnlockElement.focus();
            closeSecurityModal();
        }
    }
    function closeSecurityModal() { document.getElementById("securityModal").style.display = "none"; pendingUnlockElement = null; }
    function validateInput(e) {
        const t = e.target;
        if(t.tagName==='TEXTAREA'||t.id==='notesBox') return;
        if(t.isContentEditable) {
            // Allow numbers, Arabic numbers, backspace, delete, tab, arrows, and decimal point
            if(["Backspace","Delete","Tab","ArrowLeft","ArrowRight","Enter","."].includes(e.key)) return;
            // Check for Arabic or Western digits
            if(!/^[0-9\u0660-\u0669]$/.test(e.key)) e.preventDefault();
        }
    }

    function calcRow(el) {
        if(isClosing) return;
        const row = el.closest("tr");
        // Function to get a cleaned float value from cell content
        const getVal = (idx) => {
            const content = row.cells[idx].textContent;
            return parseFloat(convertArabic(content.replace(/,/g, ''))) || 0;
        }
        
        // Treasury(1), Inv(2), Susp(3), Cash(6), Net(7), Bank(8)
        const treasury = getVal(1);
        const purchaseInvoices = getVal(2);
        const temporarySuspensions = getVal(3);
        const actualCash = getVal(6);
        const network = getVal(7);
        const bankTransfer = getVal(8);
        const revenue = getVal(9);
        
        // Calculation: (Actual Money Collected) - (Program Revenue)
        const actual = actualCash + network + bankTransfer + treasury + purchaseInvoices + temporarySuspensions;
        const variance = actual - revenue;
        
        const varCell = row.cells[10];
        varCell.textContent = variance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        varCell.style.color = variance===0?"#aaa":(variance>0?"var(--success)":"var(--danger)");
    }
    function convertArabic(str) { 
        if (!str) return '0';
        return str.toString().replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)); 
    }

    function startClosure() {
        const row = document.querySelector(".active-row");
        const rev = parseFloat(convertArabic(row.cells[9].textContent.replace(/,/g, '')))||0;
        
        if(rev <= 0) return showToast("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø£ÙˆÙ„Ø§Ù‹!", "warning");

        const variance = parseFloat(convertArabic(row.cells[10].textContent.replace(/,/g, ''))) || 0;
        if(variance === 0) {
            const quote = quotes[Math.floor(Math.random() * quotes.length)];
            showToast(`ğŸ† ${quote} (Ù…Ø·Ø§Ø¨Ù‚ 100%)`, "gold");
        } else if (variance > 0) {
            showToast(`âœ… ÙŠÙˆØ¬Ø¯ ÙØ§Ø¦Ø¶ (${variance.toLocaleString()})`, "success");
        } else {
            showToast(`âŒ ÙŠÙˆØ¬Ø¯ Ø¹Ø¬Ø² (${variance.toLocaleString()})`, "error");
        }

        const noteText = document.getElementById("notesBox").value;
        row.dataset.fullNote = noteText;
        if(noteText.trim()) {
            row.cells[11].innerHTML = `<span class="note-has-text">ğŸ”´</span><span class="notes-tooltip">${noteText}</span>`;
            row.cells[11].classList.add('notes-cell-readonly');
        } else {
            row.cells[11].innerHTML = `<span class="note-empty">ğŸŸ¢</span><span class="notes-tooltip">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>`;
            row.cells[11].classList.add('notes-cell-readonly');
        }

        isClosing = true;
        document.getElementById("closeBtn").style.display = "none";
        document.getElementById("cancelBtn").style.display = "flex";
        row.querySelectorAll('[contenteditable]').forEach(c => c.contentEditable = false);

        let time = 30;
        const statusCell = row.cells[12];
        clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            document.getElementById("cancelBtn").textContent = `âŒ ØªØ±Ø§Ø¬Ø¹ (${time}s)`;
            statusCell.innerHTML = `<span class="status-timer">â³ ${time}s</span>`;
            time--;
            if(time < 0) finalizeClosure(row);
        }, 1000);
    }

    function cancelClosure() {
        clearInterval(timerInterval); isClosing = false;
        const row = document.querySelector(".active-row");
        row.querySelectorAll('[contenteditable]').forEach(c => c.contentEditable = true);
        
        // Revert notes cell back to initial look
        const noteText = document.getElementById("notesBox").value;
        if(noteText.trim()) {
            row.cells[11].innerHTML = `<span class="note-has-text">ğŸ”´</span><span class="notes-tooltip">${noteText}</span>`;
        } else {
            row.cells[11].innerHTML = `<span class="note-empty">ğŸŸ¢</span><span class="notes-tooltip">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</span>`;
        }

        document.getElementById("closeBtn").style.display = "flex";
        document.getElementById("cancelBtn").style.display = "none";
        row.cells[12].innerHTML = '<span class="status-active status-badge">Ù†Ø´Ø· ğŸŸ¢</span>';
    }


    // --- Logic 1: Finalize Closure (Send to API) ---
    async function finalizeClosure(row) {
        clearInterval(timerInterval); 
        isClosing = false;

        // 1. ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„ØµÙ (Indices: 0-11 - After cleaning formatting)
        const getCleanVal = (idx) => parseFloat(convertArabic(row.cells[idx].textContent.replace(/,/g, ''))) || 0;
        const closeTimeStr = new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: '2-digit', day: '2-digit' }) + " " + new Date().toLocaleTimeString('en-US', {hour12:true});

        const rowData = {
            dayName: row.cells[0].textContent,
            treasuryReserve: getCleanVal(1),
            purchaseInvoices: getCleanVal(2),
            temporarySuspensions: getCleanVal(3),
            employeeName: row.cells[4].textContent,
            closeTime: closeTimeStr,
            actualCash: getCleanVal(6),
            network: getCleanVal(7),
            bankTransfer: getCleanVal(8),
            programRevenue: getCleanVal(9),
            variance: getCleanVal(10),
            notes: row.dataset.fullNote || "",
        };

        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ (Render API)
        const response = await apiRequest("/closure/save", "POST", rowData);

        if (response && response.reportId) {
            // 3. Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­ÙØ¸: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ LocalStorage
            const all = JSON.parse(localStorage.getItem("closedRowsV10") || "[]");
            all.unshift(rowData); // Add the new object
            localStorage.setItem("closedRowsV10", JSON.stringify(all));
            
            // 4. Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø±Ø¦ÙŠ
            row.className = "closed-row";
            row.cells[5].textContent = rowData.closeTime;
            row.cells[12].innerHTML = '<span class="status-closed status-badge">ğŸ”’ Ù…ØºÙ„Ù‚</span>';

            document.getElementById("closeBtn").style.display = "flex";
            document.getElementById("cancelBtn").style.display = "none";
            document.getElementById("notesBox").value = "";
            calcClear(true); clearCashTable();
            
            loadData(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Uses the updated LocalStorage)
            showToast("âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±!", "success");

        } else {
            // 5. ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·Ø£ ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹
            // apiRequest already shows a toast on error
            cancelClosure();
        }
    }


    function applyCash() {
        const total = document.getElementById("cashTotalDisplay").textContent;
        const row = document.querySelector(".active-row");
        if(row) { 
            const cell = row.cells[6];
            cell.textContent = parseFloat(total).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            cell.dataset.autoFilled = "true"; 
            calcRow(cell); 
            showToast("ØªÙ… Ø§Ù„Ù†Ù‚Ù„ (Ø§Ù„Ø®Ø§Ù†Ø© Ù…Ø¤Ù…Ù†Ø©)", "success");
        }
    }
    
    function calcNum(n) { if(currentNum==="0"&&n!=='.')currentNum=n.toString();else currentNum+=n; updateCalcDisplay(); }
    function calcOp(op) { if(prevNum===null)prevNum=parseFloat(currentNum);else if(operator)prevNum=eval(prevNum+operator+currentNum);operator=op;currentNum="0"; }
    function calcEq() { if(!operator)return; const s=parseFloat(currentNum); const r=eval(prevNum+operator+s); addToHistory(`${prevNum} ${operator.replace('*','Ã—').replace('/','Ã·')} ${s} = ${r}`); currentNum=r.toString(); prevNum=null; operator=null; updateCalcDisplay(); }
    function calcDel(){ currentNum=currentNum.slice(0,-1)||"0"; updateCalcDisplay(); }
    function calcClear(full=false) { currentNum="0"; prevNum=null; operator=null; updateCalcDisplay(); if(full) document.getElementById("calcHistory").innerHTML = "<div>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</div>"; }
    function updateCalcDisplay() { document.getElementById("calcDisplay").value=currentNum; }
    function addToHistory(t) { const h=document.getElementById("calcHistory"); h.innerHTML=`<div>${t}</div>`+h.innerHTML; }

    function initCashTable() { 
        const t=document.querySelector("#cashCalcTable tbody"); t.innerHTML=""; 
        denoms.forEach(d=>t.innerHTML+=`<tr><td>${d}</td><td contenteditable="true" class="cash-input" onfocus="focusCell(this)" onblur="blurCell(this)" oninput="cTot()" onkeydown="validateInput(event)"></td><td style="color:#aaa">0</td></tr>`); 
    }
    function cTot(){ 
        let tot=0; 
        document.querySelectorAll("#cashCalcTable tbody tr").forEach((r,i)=>{ 
            // Use convertArabic and remove commas before parsing
            const c=parseFloat(convertArabic(r.cells[1].textContent.replace(/,/g, '')))||0; 
            const subtotal = c*denoms[i];
            r.cells[2].textContent = subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
            tot+=subtotal; 
        }); 
        document.getElementById("cashTotalDisplay").textContent = tot.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
    }
    function clearCashTable(){ 
        document.querySelectorAll(".cash-input").forEach(e=>{e.textContent=""; e.dataset.oldVal = "0"; e.dataset.autoFilled = "false"; }); 
        cTot(); 
    }

    function updateMetrics() {
        let tRev=0, tCash=0, tNet=0, tVar=0;
        const all = JSON.parse(localStorage.getItem("closedRowsV10") || "[]");
        // NOTE: all is now an array of Objects (rowData)
        all.forEach(r => {
            tRev += r.programRevenue || 0;
            tCash += (r.actualCash || 0) + (r.treasuryReserve || 0);
            tNet += (r.network || 0) + (r.bankTransfer || 0);
            tVar += r.variance || 0;
        });
        
        // Display with locale formatting
        document.getElementById("mRevenue").textContent = tRev.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById("mCash").textContent = tCash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById("mNet").textContent = tNet.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        document.getElementById("mVariance").textContent = tVar.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        document.getElementById("mVariance").style.color = tVar===0?"#aaa":(tVar>0?"var(--success)":"var(--danger)");
        
        renderCharts(all); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    }

    // --- Logic 4: Render Charts ---
    let myCharts = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø«ÙŠÙ„Ø§Øª Chart.js

    function renderCharts(data) {
        if (!data || data.length === 0) return;

        const metrics = [
            { id: "chartRevenue", dataKey: "programRevenue", color: "var(--primary)" },
            { id: "chartCash", dataKey: "actualCash", color: "var(--warning)" },
            { id: "chartNet", dataKey: "network", color: "var(--secondary)" },
            { id: "chartVariance", dataKey: "variance", color: "var(--danger)" },
        ];

        // Ù†Ø­ØªØ§Ø¬ Ù„Ø¢Ø®Ø± 15 Ù†Ù‚Ø·Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø¦ÙŠ (Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…)
        const recentData = data.slice(0, 15).reverse();
        const labels = recentData.map((_, i) => `${i + 1}`);

        metrics.forEach(metric => {
            const chartData = recentData.map(d => d[metric.dataKey] || 0);

            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (myCharts[metric.id]) {
                myCharts[metric.id].destroy();
            }

            const ctx = document.getElementById(metric.id).getContext('2d');
            myCharts[metric.id] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: chartData,
                        borderColor: metric.color,
                        borderWidth: 1.5,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    layout: { padding: 0 }
                }
            });
        });
    }


    // --- Printing Functions (Updated to use the new rowData Object structure) ---
    function printReceipt(r) {
        const w = window.open();
        w.document.write(`
            <html dir="rtl"><head><style>
                body { font-family: 'Cairo', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                @page { size: A4 portrait; margin: 15mm; } 
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
                .header h2 { margin: 5px 0; font-size: 20pt; }
                .details-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                .details-table th, .details-table td { padding: 15px; border: 1px solid #000 !important; font-size: 14pt; }
                .details-table th { background: #f0f0f0; text-align: right; width: 50%; }
                .details-table td { text-align: left; font-weight: bold; }
                .final-total { font-size: 18pt; background: #ddd; }
                .signature-area { margin-top: 50px; display: flex; justify-content: flex-end; width: 100%; }
                .signature-box { border-top: 2px solid #000; width: 35%; text-align: center; padding-top: 10px; font-size: 14pt; }
                .breakdown-table { width: 100%; margin-top: 15px; border-collapse: collapse; font-size: 12pt; }
                .breakdown-table th, .breakdown-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
            </style></head><body>
            <div class="header">
                <h2>Ø³Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ ØµÙ†Ø¯ÙˆÙ‚ Ø±Ø³Ù…ÙŠ</h2>
                <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${r.closeTime}</p>
            </div>
            <table class="details-table">
                <thead><tr><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø¬.Ù…)</th></tr></thead>
                <tbody>
                    <tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><td>${r.employeeName}</td></tr>
                    <tr><th>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th><td>${r.treasuryReserve.toLocaleString()}</td></tr>
                    <tr><th>ÙÙˆØ§ØªÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª</th><td>${r.purchaseInvoices.toLocaleString()}</td></tr>
                    <tr><th>Ù…Ø¹Ù„Ù‚Ø§Øª Ù…Ø¤Ù‚ØªØ©</th><td>${r.temporarySuspensions.toLocaleString()}</td></tr>
                    <tr><th>Ø§Ù„ÙƒØ§Ø´ Ø§Ù„ÙØ¹Ù„ÙŠ</th><td>${r.actualCash.toLocaleString()}</td></tr>
                    <tr><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„</th><td>${((r.network||0)+(r.bankTransfer||0)).toLocaleString()}</td></tr>
                    <tr><th>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th><td>${r.programRevenue.toLocaleString()}</td></tr>
                    <tr class="final-total"><th>ØµØ§ÙÙŠ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th><td>${r.variance.toLocaleString()}</td></tr>
                </tbody>
            </table>
            
            <h3>ØªÙØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
            <table class="breakdown-table">
                <thead><tr><th>ÙÙˆØ§ØªÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª</th><th>Ù…Ø¹Ù„Ù‚Ø§Øª Ù…Ø¤Ù‚ØªØ©</th></tr></thead>
                <tbody><tr><td>${r.purchaseInvoices.toLocaleString()}</td><td>${r.temporarySuspensions.toLocaleString()}</td></tr></tbody>
            </table>

            <p style="text-align:right;"><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${r.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª'}</p>
            <div class="signature-area">
                <div class="signature-box">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù</div>
            </div>
            <script>window.print();window.close();<\/script></body></html>
        `);
        w.document.close();
    }
    
    function printLast() {
        const all = JSON.parse(localStorage.getItem("closedRowsV10") || "[]");
        // All is now an array of objects
        if(all.length) printReceipt(all[0]);
    }
    function printAll() {
        const all = JSON.parse(localStorage.getItem("closedRowsV10") || "[]");
        printData(all, "Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø§Øª");
    }
    
    function printData(rows, t) {
        const w = window.open();
        let h = `<html dir="rtl"><head><style>body{font-family:sans-serif;padding:20px;}table{width:100%;border-collapse:collapse;font-size:0.8rem;}th,td{border:1px solid #000;padding:5px;text-align:center;}</style></head><body><h2 style="text-align:center">${t}</h2><table><thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th><th>ÙÙˆØ§ØªÙŠØ±</th><th>Ù…Ø¹Ù„Ù‚Ø§Øª</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ÙƒØ§Ø´</th><th>Ø§Ù„Ø´Ø¨ÙƒØ©</th><th>ØªØ­ÙˆÙŠÙ„</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th><th>Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>`;
        
        // Loop over the array of objects
        rows.forEach(r => h+=`<tr>
            <td>${r.dayName}</td><td>${r.treasuryReserve.toLocaleString()}</td><td>${r.purchaseInvoices.toLocaleString()}</td><td>${r.temporarySuspensions.toLocaleString()}</td>
            <td>${r.employeeName}</td><td>${r.closeTime}</td><td>${r.actualCash.toLocaleString()}</td><td>${r.network.toLocaleString()}</td>
            <td>${r.bankTransfer.toLocaleString()}</td><td>${r.programRevenue.toLocaleString()}</td><td>${r.variance.toLocaleString()}</td><td>${r.notes || ''}</td>
            </tr>`);
        
        h+=`</tbody></table><script>window.print();window.close();<\/script></body></html>`;
        w.document.write(h); w.document.close();
    }

    function logout() { localStorage.removeItem("username"); window.location.href="index.html"; }
    function showToast(msg, t="info") {
        const d=document.createElement("div"); d.className=`toast toast-${t}`; d.textContent=msg;
        document.getElementById("toastContainer").appendChild(d); setTimeout(()=>d.remove(), 2000);
    }
</script>
</body>
</html>